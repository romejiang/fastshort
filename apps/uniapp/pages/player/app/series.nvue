<template>
  <view class="container">
    <!-- #ifdef APP -->
    <!-- ÁÇπËµûÁâπÊïàÂ±Ç -->
    <likeEffect
      v-if="isLikePlay"
      v-model="isLikePlay"
      :position="likePosition"
    />

    <!-- ÊúÄÂ§ñÂ±ÇÁöÑviewÔºåÊéßÂà∂Êï¥‰∏™ÁöÑÈ´òÂ∫¶Ôºå‰ª•ÂèäÂÆΩÂ∫¶ -->
    <view :style="styleWidthHeight">
      <list
        @loadmore="listLoadMore"
        :loadmoreoffset="windowHeight * 3"
        @scroll="listScroll"
        :show-scrollbar="false"
        :pagingEnabled="true"
        :scrollable="true"
      >
        <!-- Âà∑Êñ∞Ê®°Âùó -->
        <refresh
          class="refresh"
          @refresh="onRefresh"
          @pullingdown="onPullingDown"
          :display="refreshing ? 'show' : 'hide'"
        >
          <loading style="background-color: #ffffff">
            <image
              src="@/static/img/index/logins.gif"
              style="
                width: 50rpx;
                height: 25rpx;
                margin-top: 80rpx;
                margin-bottom: 30rpx;
                margin-left: 350rpx;
              "
            ></image>
          </loading>
        </refresh>

        <!-- Âæ™ÁéØÊï∞ÊçÆ -->
        <cell v-for="(videoItem, i) in dataList" :key="i">
          <!-- Áî®divÊääËßÜÈ¢ëÊ®°ÁªÑÂ•óËµ∑Êù• -->
          <div :style="styleWidthHeight" :ref="i">
            <view v-if="currentPlayer - i <= 1">
              <view class="root">
                <video
                  :id="videoItem._id"
                  :loop="true"
                  :src="videoItem.video[0]"
                  :muted="videoItem.state != 'play'"
                  @play="videoPlay(i)"
                  :enable-progress-gesture="false"
                  :page-gesture="false"
                  :controls="false"
                  :http-cache="true"
                  :show-loading="false"
                  :show-fullscreen-btn="false"
                  :show-center-play-btn="false"
                  :style="styleWidthHeight"
                  object-fit="cover"
                  @timeupdate="videoTimeUpdate($event, i)"
                ></video>
                <!-- ËøôÈáåÊòØÂ∞ÅÈù¢ -->
                <!-- <image
                  v-if="!videoItem.playIng"
                  :src="videoItem.cover[0]"
                  mode="cover"
                  style="position: absolute;"
                  :style="styleWidthHeight"
                ></image> -->
              </view>
              <!-- Ëøô‰∏™ÊòØÊöÇÂÅúÊó∂Âá∫Áé∞ÁöÑÂõæÊ†á -->
              <view
                class="videoHover"
                @touchstart="playerClick(videoItem.state, $event)"
                :style="styleWidthHeight"
              >
                <image
                  v-if="videoItem.state != 'play'"
                  class="playState"
                  src="@/static/img/index/play.png"
                ></image>
              </view>
              <view class="userInfo">
                <!-- 1.Â§¥ÂÉè -->
                <avatar :avatar="videoItem.cover[0]" @click="clickAvatar(i)" />
                <!-- 2.ÁÇπËµû -->
                <like
                  :like="videoItem.like"
                  :isLike="videoItem.isLike"
                  :series="videoItem.series"
                  @click="clickLike"
                />
                <!-- 3.ËØÑËÆ∫ -->
                <comment
                  :total="videoItem.comments"
                  :index="i"
                  @click="openComment"
                />

                <comment
                  :total="videoItem.comments"
                  :index="i"
                  @click="openEpisode"
                />

                <!-- 4.ÂàÜ‰∫´ -->
                <share @click="clickShare" />
                <!-- 5.ËΩ¨ËΩÆ -->
              </view>
              <!-- ÊúÄÂ∫ï‰∏ãÁöÑÊñáÂ≠óÈÉ®ÂàÜ -->
            </view>
          </div>
          <topbar
            :title="videoItem.title"
            :episode="videoItem.episode"
          ></topbar>
        </cell>
      </list>
      <!-- ËøõÂ∫¶Êù° -->
      <progressbar
        :totalTime="totalTime"
        :currentTime="currentTime"
        bottom="20"
        @seek="progressBarSeek"
      ></progressbar>
    </view>
    <!--
		ÂºïÂÖ•ËØÑËÆ∫
		-->

    <uni-popup ref="episodeRef">
      <episode
        @closeEpisode="closeEpisode"
        :list="dataList"
        :index="currentPlayer"
        :info="{}"
      ></episode>
    </uni-popup>
    <!-- #endif -->
    <!-- #ifndef APP -->
    <webPanel />
    <!-- #endif -->
  </view>
</template>
<script>
// import douyinScrollview from '@/components/comment/app.nvue'

import topbar from '@/components/topbar.vue'
import episode from '@/components/episode.vue'
import progressbar from '@/pages/player/app/progressbar.vue'
import likeEffect from '@/components/likeEffect.vue'
import like from '@/components/like.vue'
import comment from '@/components/comment.vue'
import share from '@/components/share.vue'
import cover from '@/components/cover.vue'
import message from '@/components/message.vue'
import avatar from '@/components/avatar.vue'
import request from '@/common/request'

export default {
  components: {
    topbar,
    episode,
    progressbar,
    webPanel,
    likeEffect,
    avatar,
    like,
    comment,
    share,
    cover,
    message
  },
  data() {
    return {
      //Áî®‰∫éÊï∞ÊçÆÂæ™ÁéØÁöÑÂàóË°®ÔºåÂåÖÊã¨ËßÜÈ¢ëÂíåÂ∞ÅÈù¢
      dataList: [],
      // ÊâÄÊúâÊí≠ÊîæÂô®ÁöÑÂÖ∑ÊüÑÔºåÊñπ‰æøË∞ÉÁî®
      videoContextList: {},
      currentPlayer: -1, //ÂΩìÂâçÊí≠ÊîæÁöÑËßÜÈ¢ëindexÔºåÈªòËÆ§‰∏∫0üåüüíó

      refreshing: true, //Áî®‰∫é‰∏ãÊãâÂà∑Êñ∞üåüüíó

      windowWidth: 0, //Ëé∑ÂèñÂ±èÂπïÂÆΩÂ∫¶üåüüíó
      windowHeight: 0,
      tabberHeight: 0, //ÊµãËØïÈ´òÂ∫¶üåüüíó

      platform: '', //Áî®‰∫éËé∑ÂèñÊìç‰ΩúÁ≥ªÁªüÔºöios„ÄÅandroidüåüüíó
      isSwiperDragging: false, //false‰ª£Ë°®ÂÅúÊ≠¢ÊªëÂä®üåüüíó

      totalTime: 0,
      currentTime: 0,

      isAutoplay: false, //ÊòØÂê¶ÂºÄÂêØËá™Âä®Êí≠Êîæ(ÈªòËÆ§‰∏çÂºÄÂêØ)

      // ËØÑËÆ∫ÊµÆÂ±ÇÁöÑÈ´òÂ∫¶
      commentHeight: 1.18,
      // ÂèåÂáªÁÇπËµûÂèÇÊï∞
      numberOfClicks: 0,
      dblClickTimer: null,
      // ÊòæÁ§∫ÁÇπËµûÁâπÊïàÂíå‰ΩçÁΩÆ
      isLikePlay: false,
      likePosition: {},

      // ‰∏¥Êó∂ÂèòÈáèÔºåÁî®‰∫éÂÆöÊó∂Âô®
      pauseTimer: null,
      preloadTimer: null,
      timers: ''
    }
  },

  watch: {
    currentPlayer(val, oldVal) {
      console.log('watch currentPlayer: ', val)
      // ÂÅúÊ≠¢ËÄÅÁöÑËßÜÈ¢ë
      if (val >= 0) {
        this.stopVideo(oldVal)
        // Êí≠ÊîæÂΩìÂâçËßÜÈ¢ëÔºåÂπ∂È¢ÑÂÖàÂä†ËΩΩ‰∏ã‰∏Ä‰∏™ËßÜÈ¢ë
        this.playVideo(val)
      }
    }
  },
  computed: {
    styleWidthHeight() {
      return `width: 750rpx; height: ${
        this.windowHeight - this.tabberHeight
      }px;`
    },
    ready: function () {
      return this.dataList.length > 0 && this.currentPlayer >= 0
    }
  },
  onShow() {
    console.log('ÂõûÂà∞ÂâçÂè∞')
    if (this.ready) {
      this.dataList[this.currentPlayer].state = 'play'
      this.getVideoContext(this.currentPlayer).play()
    }
  },
  onHide() {
    console.log('Âà∞ÂêéÂè∞')
    if (this.ready) {
      this.dataList[this.currentPlayer].state = 'pause'
      this.getVideoContext(this.currentPlayer).pause()
    }
  },
  async onLoad(option) {
    this.windowWidth = uni.getSystemInfoSync().screenWidth
    this.windowHeight = uni.getSystemInfoSync().screenHeight

    this.platform = uni.getSystemInfoSync().platform
    const model = uni.getSystemInfoSync().model
    if (
      this.platform == 'ios' &&
      (model !== 'iPhone6' ||
        model !== 'iPhone6s' ||
        model !== 'iPhone7' ||
        model !== 'iPhone8')
    ) {
      this.tabberHeight = 32
      this.commentHeight = 1.4
    } else {
      this.tabberHeight = 0
      this.commentHeight = 1.4
    }

    await this.loadData(option)
  },
  methods: {
    // Ëé∑ÂèñÊí≠ÊîæÂô®ÂØπË±°ÁöÑÂ∑•ÂéÇÊñπÊ≥ï
    getVideoContext(index) {
      if (this.videoContextList[index]) {
        return this.videoContextList[index]
      } else {
        const videoContext = uni.createVideoContext(
          this.dataList[index]._id,
          this
        )
        this.videoContextList[index] = videoContext
        return videoContext
      }
    },
    // Êí≠ÊîæÂΩìÂâçËßÜÈ¢ëÔºåÂπ∂È¢ÑÂÖàÂä†ËΩΩ‰∏Ä‰∏ã‰∏Ä‰∏™ËßÜÈ¢ë
    playVideo(index) {
      if (index >= 0) {
        this.dataList[index].state = 'play'
        console.log('play: ', index)
        setTimeout(() => {
          const videoContext = this.getVideoContext(index)
          if (this.platform == 'ios') {
            videoContext.play()
          } else {
            videoContext.pause()
            videoContext.play()
          }
        }, 100)
        if (index + 2 < this.dataList.length) {
          setTimeout(() => {
            const nextVideoContext = this.getVideoContext(index + 1)
            // Âõ†‰∏∫ÈªòËÆ§ÊòØÈùôÈü≥ÁöÑÔºåÊâÄ‰ª•playÂêéÁî®Êà∑ÊÑüÂèó‰∏çÂà∞Ôºå‰ΩÜÂèàÂèØ‰ª•È¢ÑÂÖàÂä†ËΩΩÂÜÖÂÆπ
            nextVideoContext.play()
            clearTimeout(this.preloadTimer)
            this.preloadTimer = setTimeout(() => {
              nextVideoContext.seek(0)
              nextVideoContext.pause()
            }, 1500)
          }, 500)
        }
      }
    },
    // ÂÅúÊ≠¢Êí≠ÊîæËßÜÈ¢ë
    stopVideo(index) {
      if (index >= 0) {
        this.dataList[index].state = 'stop'
        clearTimeout(this.pauseTimer)
        this.pauseTimer = setTimeout(() => {
          const videoContext = this.getVideoContext(index)
          videoContext.pause()
          videoContext.seek(0)
        }, 500)
      }
    },
    // Âä†ËΩΩÈ¶ñÈ°µÊï∞ÊçÆ
    async loadData(option) {
      const data = await request.post('/public/series', option)

      this.dataList = data
      // Ê£ÄÊü•ÊòØÂê¶Ë∑≥ËøáÁ¨¨Âá†ÈõÜ
      const seek = option.index ? Number(option.index) : 0
      if (0 < seek && seek < this.dataList.length) {
        this.swiperSelected(seek)
      } else {
        // ÈªòËÆ§Êí≠ÊîæÁ¨¨‰∏Ä‰∏™ËßÜÈ¢ë
        this.currentPlayer = 0
      }
    },
    listLoadMore() {},

    // ‰∏äÊªëÔºåÊòæÁ§∫‰∏ã‰∏Ä‰∏™ËßÜÈ¢ë
    listScroll(event) {
      this.isSwiperDragging = event.isDragging
      if (!event.isDragging) {
        var i = Math.round(
          Math.abs(event.contentOffset.y) /
            (this.windowHeight - this.tabberHeight + 1)
        )
        if (i !== this.currentPlayer && this.currentPlayer >= 0) {
          clearTimeout(this.timers)
          this.timers = setTimeout(() => {
            this.currentPlayer = i
            console.log(
              'Ê≠£Âú®Êí≠Êîæ --> Á¨¨' + (this.currentPlayer + 1) + '‰∏™ËßÜÈ¢ëÔΩû'
            )
          }, 80)
        }
      }
    },

    //ÁÇπÂáªÊí≠Êîæ&&ÊöÇÂÅú
    playerClick(state, event) {
      console.log('playerClick....')
      if (this.currentPlayer < 0) {
        return
      }
      // Â§ÑÁêÜÂèåÂáª‰∫ã‰ª∂
      this.numberOfClicks++
      if (this.dblClickTimer) {
        clearTimeout(this.dblClickTimer)
      }
      this.dblClickTimer = setTimeout(() => {
        if (this.numberOfClicks == 1) {
          // Â¶ÇÊûúÊòØÂçïÂáª
          if (state == 'play') {
            this.dataList[this.currentPlayer].state = 'pause'
            this.getVideoContext(this.currentPlayer).pause()
          } else {
            this.dataList[this.currentPlayer].state = 'play'
            this.getVideoContext(this.currentPlayer).play()
          }
        } else if (this.numberOfClicks > 1) {
          // Â¶ÇÊûúÊòØÂèåÂáª
          this.doubleLike(event)
        }
        this.numberOfClicks = 0
      }, 400)
    },
    doubleLike(event) {
      if (!this.dataList[this.currentPlayer].isLike) {
        this.dataList[this.currentPlayer].like += 1
        this.dataList[this.currentPlayer].isLike = true
      }
      this.likePosition = event.touches[0]
      this.isLikePlay = true
    },

    progressBarSeek(seek) {
      console.log('seek: ', seek)
      this.getVideoContext(this.currentPlayer).seek(seek)
      this.getVideoContext(this.currentPlayer).play()
      this.dataList[this.currentPlayer].state = 'play'
    },

    // Êõ¥Êñ∞ËøõÂ∫¶Êù°Ë°®
    videoTimeUpdate(event, index) {
      //ËÆ°ÁÆóÊªëÂùóÂΩìÂâç‰ΩçÁΩÆÔºåËÆ°ÁÆóÂΩìÂâçÁôæÂàÜÂ∞èÊï∞
      if (index == this.currentPlayer) {
        this.totalTime = event.detail.duration
        this.currentTime = event.detail.currentTime

        //Ëá™Âä®ÂàáÊç¢ËßÜÈ¢ë
        if (this.isAutoplay) {
          //true,‰ª£Ë°®Ëá™Âä®Êí≠Êîæ
          if (event.detail.currentTime + 0.1 >= event.detail.duration) {
            this.swiperSelected(this.currentPlayer + 1)
          }
        }
      }
    },
    swiperSelected(index) {
      setTimeout(() => {
        const dom = uni.requireNativePlugin('dom')
        const el = this.$refs[index][0]
        dom.scrollToElement(el, {
          offset: 0,
          animated: false
        })
        this.currentPlayer = index
      }, 100)
    },
    stop() {
      // console.log('stop')
    },

    onPullingDown() {
      // console.log('Ê≠£Âú®‰∏ãÊãâÂà∑Êñ∞ÔºåÊ≠§Êó∂ÊâãËøòÂú®Ëß¶Êë∏Ê≤°ÊúâÊùæÂºÄ')
      this.refreshing = true
    },
    onRefresh() {
      // console.log('‰∏ãÊãâÂà∑Êñ∞ÂÆåÊØïÔºåÊ≠§Êó∂ÊâãÊùæÂºÄ‰∫Ü')
      setTimeout(() => {
        this.refreshing = false
      }, 1000)
    },

    openEpisode(index) {
      this.$refs.episodeRef.open('bottom')
    },
    closeEpisode(i) {
      // ÁÇπÂáªËØÑËÆ∫ÈáåÈù¢ÁöÑÂèâÂèâÔºåÂ∞±‰ºöÂÖ≥Èó≠ËØÑËÆ∫
      this.swiperSelected(i)
      this.$refs.episodeRef.close()
    },
    openComment(index) {
      this.$refs.pinglun.open('bottom')
    },
    clickShare() {
      uni.showToast({
        title: 'ÂàÜ‰∫´',
        icon: 'none'
      })
    },

    clickLike(like) {
      this.dataList[this.currentPlayer].isLike =
        !this.dataList[this.currentPlayer].isLike
      const video = this.dataList[this.currentPlayer]
      like ? (video.like ? video.like-- : video.like == 0) : video.like++
    },

    clickAvatar(i) {},

    closeCommentHandle() {},
    closeComment() {
      // ÁÇπÂáªËØÑËÆ∫ÈáåÈù¢ÁöÑÂèâÂèâÔºåÂ∞±‰ºöÂÖ≥Èó≠ËØÑËÆ∫
      this.$refs.pinglun.close()
    },

    // ËßÜÈ¢ëÊí≠ÊîæÁöÑ‰∏Ä‰∏™ÂõûË∞ÉÈÄöÁü•Ôºå
    videoPlay(index) {
      setTimeout(() => {
        this.dataList[index].playIng = true
      }, 200)
    },

    clickCover() {
      uni.showToast({
        title: 'Â§ÑÁêÜÂ£∞Èü≥',
        icon: 'none'
      })
    }
  }
}
</script>
<style scoped>
.container {
  background-color: #000000;
}
.videoHover {
  position: absolute;
  top: 0;
  left: 0;
  flex: 1;
  background-color: rgba(0, 0, 0, 0.1);
  justify-content: center;
  align-items: center;
}
.playState {
  width: 160rpx;
  height: 160rpx;
  opacity: 0.2;
}
.userInfo {
  position: absolute;
  bottom: 80px;
  right: 10px;
  flex-direction: column;
}
</style>
