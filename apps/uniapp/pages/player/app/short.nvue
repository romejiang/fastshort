<template>
  <view class="container">
    <!-- #ifdef APP -->
    <!-- ç‚¹èµç‰¹æ•ˆå±‚ -->
    <likeEffect
      v-if="isLikePlay"
      v-model="isLikePlay"
      :position="likePosition"
    />
    <!-- æœ€å¤–å±‚çš„viewï¼Œæ§åˆ¶æ•´ä¸ªçš„é«˜åº¦ï¼Œä»¥åŠå®½åº¦ -->
    <view :style="styleWidthHeight">
      <list
        @loadmore="listLoadMore"
        :loadmoreoffset="windowHeight * 3"
        @scroll="listScroll"
        :show-scrollbar="false"
        :pagingEnabled="true"
        :scrollable="true"
      >
        <!-- åˆ·æ–°æ¨¡å— -->
        <refresh
          class="refresh"
          @refresh="onRefresh"
          @pullingdown="onPullingDown"
          :display="refreshing ? 'show' : 'hide'"
        >
          <loading style="background-color: #ffffff">
            <image
              src="@/static/img/index/logins.gif"
              :style="
                'width: 80upx; height: 40upx; margin-top: 80upx; margin-bottom: 30upx; margin-left: ' +
                (windowWidth - 200) +
                'px;'
              "
            ></image>
          </loading>
        </refresh>

        <!-- å¾ªç¯æ•°æ® -->
        <cell v-for="(videoItem, i) in dataList" :key="i">
          <!-- ç”¨divæŠŠè§†é¢‘æ¨¡ç»„å¥—èµ·æ¥ -->
          <div :style="styleWidthHeight" :ref="i">
            <view v-if="currentPlayer - i <= 1">
              <view class="root">
                <video
                  :id="videoItem._id"
                  :loop="true"
                  :src="videoItem.video[0]"
                  :muted="videoItem.state != 'play'"
                  @play="videoPlay(i)"
                  :enable-progress-gesture="false"
                  :page-gesture="false"
                  :controls="false"
                  :http-cache="true"
                  :show-loading="false"
                  :show-fullscreen-btn="false"
                  :show-center-play-btn="false"
                  :style="styleWidthHeight"
                  object-fit="cover"
                  @timeupdate="videoTimeUpdate($event, i)"
                ></video>
                <!-- è¿™é‡Œæ˜¯å°é¢ -->
                <!-- <image
                  v-if="!videoItem.playIng"
                  :src="videoItem.cover[0]"
                  mode="cover"
                  style="position: absolute;"
                  :style="styleWidthHeight"
                ></image> -->
              </view>
              <!-- è¿™ä¸ªæ˜¯æš‚åœæ—¶å‡ºç°çš„å›¾æ ‡ -->
              <view
                class="videoHover"
                @touchstart="playerClick(videoItem.state, $event)"
                :style="styleWidthHeight"
              >
                <image
                  v-if="videoItem.state != 'play'"
                  class="playState"
                  src="@/static/img/index/play.png"
                ></image>
              </view>
              <view class="userInfo">
                <!-- 1.å¤´åƒ -->
                <avatar :avatar="videoItem.cover[0]" @click="clickAvatar(i)" />
                <!-- 2.ç‚¹èµ -->
                <like
                  :like="videoItem.like"
                  :isLike="videoItem.isLike"
                  :series="videoItem.series"
                  @click="clickLike"
                />
                <!-- 3.è¯„è®º -->
                <comment
                  :total="videoItem.comments"
                  :index="i"
                  @click="openComment"
                />
                <!-- 4.åˆ†äº« -->
                <share @click="clickShare" />
                <!-- 5.è½¬è½® -->
              </view>
              <!-- æœ€åº•ä¸‹çš„æ–‡å­—éƒ¨åˆ† -->
              <message
                v-if="dataList.length !== 0"
                :title="videoItem.title"
                :msg="videoItem.description"
                :test="currentPlayer + 1"
              />
            </view>
          </div>
        </cell>
      </list>
      <!-- è¿›åº¦æ¡ -->
      <progressbar
        :totalTime="totalTime"
        :currentTime="currentTime"
        @seek="progressBarSeek"
      ></progressbar>
    </view>
    <!--
		å¼•å…¥è¯„è®º
		-->
    <uni-popup ref="pinglun">
      <comments @closeComment="closeComment"></comments>
    </uni-popup>
    <!-- #endif -->
  </view>
</template>
<script>
import comments from '@/components/comment/index.vue'
import progressbar from '@/pages/player/app/progressbar.vue'
import likeEffect from '@/components/likeEffect.vue'
import like from '@/components/like.vue'
import comment from '@/components/comment.vue'
import share from '@/components/share.vue'
import cover from '@/components/cover.vue'
import message from '@/components/message.vue'
import avatar from '@/components/avatar.vue'
import request from '@/common/request'

export default {
  components: {
    comments,
    progressbar,
    likeEffect,
    avatar,
    like,
    comment,
    share,
    cover,
    message
  },
  data() {
    return {
      dataList: [], //ç”¨äºæ•°æ®å¾ªç¯çš„åˆ—è¡¨ğŸŒŸğŸ’—
      // æ‰€æœ‰æ’­æ”¾å™¨çš„å…·æŸ„ï¼Œæ–¹ä¾¿è°ƒç”¨
      videoContextList: {},
      currentPlayer: -1, //å½“å‰æ’­æ”¾çš„è§†é¢‘indexï¼Œé»˜è®¤ä¸º0ğŸŒŸğŸ’—

      refreshing: true, //ç”¨äºä¸‹æ‹‰åˆ·æ–°ğŸŒŸğŸ’—

      windowWidth: 0, //è·å–å±å¹•å®½åº¦ğŸŒŸğŸ’—
      windowHeight: 0,
      tabberHeight: 0, //æµ‹è¯•é«˜åº¦ğŸŒŸğŸ’—

      platform: '', //ç”¨äºè·å–æ“ä½œç³»ç»Ÿï¼šiosã€androidğŸŒŸğŸ’—
      isSwiperDragging: false, //falseä»£è¡¨åœæ­¢æ»‘åŠ¨ğŸŒŸğŸ’—

      totalTime: 0,
      currentTime: 0,

      isAutoplay: false, //æ˜¯å¦å¼€å¯è‡ªåŠ¨æ’­æ”¾(é»˜è®¤ä¸å¼€å¯)

      // è¯„è®ºæµ®å±‚çš„é«˜åº¦
      commentHeight: 1.18,
      // åŒå‡»ç‚¹èµå‚æ•°
      numberOfClicks: 0,
      dblClickTimer: null,
      // æ˜¾ç¤ºç‚¹èµç‰¹æ•ˆå’Œä½ç½®
      isLikePlay: false,
      likePosition: {},

      // ä¸´æ—¶å˜é‡ï¼Œç”¨äºå®šæ—¶å™¨
      pauseTimer: null,
      preloadTimer: null,
      timers: ''
    }
  },

  watch: {
    currentPlayer(val, oldVal) {
      console.log('watch currentPlayer: ', val)
      // åœæ­¢è€çš„è§†é¢‘
      if (val >= 0) {
        this.stopVideo(oldVal)
        // æ’­æ”¾å½“å‰è§†é¢‘ï¼Œå¹¶é¢„å…ˆåŠ è½½ä¸‹ä¸€ä¸ªè§†é¢‘
        this.playVideo(val)
      }
    }
  },
  computed: {
    styleWidthHeight() {
      return `width: ${this.windowWidth}px; height: ${
        this.windowHeight - this.tabberHeight
      }px;`
    },
    ready: function () {
      return this.dataList.length > 0 && this.currentPlayer >= 0
    }
  },
  onShow() {
    console.log('å›åˆ°å‰å°')
    if (this.ready) {
      this.dataList[this.currentPlayer].state = 'play'
      this.getVideoContext(this.currentPlayer).play()
    }
  },
  onHide() {
    console.log('åˆ°åå°')
    if (this.ready) {
      this.dataList[this.currentPlayer].state = 'pause'
      this.getVideoContext(this.currentPlayer).pause()
    }
  },
  async onLoad(option) {
    this.windowWidth = uni.getSystemInfoSync().screenWidth
    this.windowHeight = uni.getSystemInfoSync().screenHeight

    this.platform = uni.getSystemInfoSync().platform
    const model = uni.getSystemInfoSync().model
    if (
      this.platform == 'ios' &&
      (model !== 'iPhone6' ||
        model !== 'iPhone6s' ||
        model !== 'iPhone7' ||
        model !== 'iPhone8')
    ) {
      this.tabberHeight = 50 + 32
      this.commentHeight = 1.4
    } else {
      this.tabberHeight = 50
      this.commentHeight = 1.4
    }

    await this.loadData(option)
    // this.openComment()
  },
  methods: {
    // è·å–æ’­æ”¾å™¨å¯¹è±¡çš„å·¥å‚æ–¹æ³•
    getVideoContext(index) {
      if (this.videoContextList[index]) {
        return this.videoContextList[index]
      } else {
        const videoContext = uni.createVideoContext(
          this.dataList[index]._id,
          this
        )
        this.videoContextList[index] = videoContext
        return videoContext
      }
    },
    // æ’­æ”¾å½“å‰è§†é¢‘ï¼Œå¹¶é¢„å…ˆåŠ è½½ä¸€ä¸‹ä¸€ä¸ªè§†é¢‘
    playVideo(index) {
      if (index >= 0) {
        this.dataList[index].state = 'play'
        console.log('play: ', index)
        setTimeout(() => {
          const videoContext = this.getVideoContext(index)
          if (this.platform == 'ios') {
            videoContext.play()
          } else {
            videoContext.pause()
            videoContext.play()
          }
        }, 100)
        if (index + 2 < this.dataList.length) {
          setTimeout(() => {
            const nextVideoContext = this.getVideoContext(index + 1)
            // å› ä¸ºé»˜è®¤æ˜¯é™éŸ³çš„ï¼Œæ‰€ä»¥playåç”¨æˆ·æ„Ÿå—ä¸åˆ°ï¼Œä½†åˆå¯ä»¥é¢„å…ˆåŠ è½½å†…å®¹
            nextVideoContext.play()
            clearTimeout(this.preloadTimer)
            this.preloadTimer = setTimeout(() => {
              nextVideoContext.seek(0)
              nextVideoContext.pause()
            }, 1500)
          }, 500)
        }
      }
    },
    // åœæ­¢æ’­æ”¾è§†é¢‘
    stopVideo(index) {
      if (index >= 0) {
        this.dataList[index].state = 'stop'
        clearTimeout(this.pauseTimer)
        this.pauseTimer = setTimeout(() => {
          const videoContext = this.getVideoContext(index)
          videoContext.pause()
          videoContext.seek(0)
        }, 500)
      }
    },
    // åŠ è½½é¦–é¡µæ•°æ®
    async loadData(option) {
      const data = await request.post('/public/short')
      this.dataList = data
      // æ£€æŸ¥æ˜¯å¦è·³è¿‡ç¬¬å‡ é›†
      const seek = option.index ? Number(option.index) : 0
      if (0 < seek && seek < this.dataList.length) {
        this.$nextTick(() => {
          setTimeout(() => {
            const dom = uni.requireNativePlugin('dom')
            const el = this.$refs[seek][0]
            dom.scrollToElement(el, {
              offset: 0,
              animated: false
            })
            this.currentPlayer = seek
          }, 100)
        })
      } else {
        // é»˜è®¤æ’­æ”¾ç¬¬ä¸€ä¸ªè§†é¢‘
        this.currentPlayer = 0
      }
    },
    listLoadMore() {},

    // ä¸Šæ»‘ï¼Œæ˜¾ç¤ºä¸‹ä¸€ä¸ªè§†é¢‘
    listScroll(event) {
      this.isSwiperDragging = event.isDragging
      if (!event.isDragging) {
        var i = Math.round(
          Math.abs(event.contentOffset.y) /
            (this.windowHeight - this.tabberHeight + 1)
        )
        if (i !== this.currentPlayer && this.currentPlayer >= 0) {
          clearTimeout(this.timers)
          this.timers = setTimeout(() => {
            this.currentPlayer = i
            console.log(
              'æ­£åœ¨æ’­æ”¾ --> ç¬¬' + (this.currentPlayer + 1) + 'ä¸ªè§†é¢‘ï½'
            )
          }, 80)
        }
      }
    },

    //ç‚¹å‡»æ’­æ”¾&&æš‚åœ
    playerClick(state, event) {
      console.log('playerClick....')
      if (this.currentPlayer < 0) {
        return
      }
      // å¤„ç†åŒå‡»äº‹ä»¶
      this.numberOfClicks++
      if (this.dblClickTimer) {
        clearTimeout(this.dblClickTimer)
      }
      this.dblClickTimer = setTimeout(() => {
        if (this.numberOfClicks == 1) {
          // å¦‚æœæ˜¯å•å‡»
          if (state == 'play') {
            this.dataList[this.currentPlayer].state = 'pause'
            this.getVideoContext(this.currentPlayer).pause()
          } else {
            this.dataList[this.currentPlayer].state = 'play'
            this.getVideoContext(this.currentPlayer).play()
          }
        } else if (this.numberOfClicks > 1) {
          // å¦‚æœæ˜¯åŒå‡»
          this.doubleLike(event)
        }
        this.numberOfClicks = 0
      }, 400)
    },
    doubleLike(event) {
      if (!this.dataList[this.currentPlayer].isLike) {
        this.dataList[this.currentPlayer].like += 1
        this.dataList[this.currentPlayer].isLike = true
      }
      this.likePosition = event.touches[0]
      this.isLikePlay = true
    },

    progressBarSeek(seek) {
      console.log('seek: ', seek)
      this.getVideoContext(this.currentPlayer).seek(seek)
      this.getVideoContext(this.currentPlayer).play()
      this.dataList[this.currentPlayer].state = 'play'
    },

    // æ›´æ–°è¿›åº¦æ¡è¡¨
    videoTimeUpdate(event, index) {
      //è®¡ç®—æ»‘å—å½“å‰ä½ç½®ï¼Œè®¡ç®—å½“å‰ç™¾åˆ†å°æ•°
      if (index == this.currentPlayer) {
        this.totalTime = event.detail.duration
        this.currentTime = event.detail.currentTime

        //è‡ªåŠ¨åˆ‡æ¢è§†é¢‘
        if (this.isAutoplay) {
          //true,ä»£è¡¨è‡ªåŠ¨æ’­æ”¾
          if (event.detail.currentTime + 1 >= event.detail.duration) {
            const dom = uni.requireNativePlugin('dom')
            let doms = this.currentPlayer + 1
            setTimeout(() => {
              let el = this.$refs[doms][0]
              dom.scrollToElement(el, {
                offset: 0,
                animated: true
              })
            }, 500)
          }
        }
      }
    },

    stop() {
      // console.log('stop')
    },

    onPullingDown() {
      // console.log('æ­£åœ¨ä¸‹æ‹‰åˆ·æ–°ï¼Œæ­¤æ—¶æ‰‹è¿˜åœ¨è§¦æ‘¸æ²¡æœ‰æ¾å¼€')
      this.refreshing = true
    },
    onRefresh() {
      // console.log('ä¸‹æ‹‰åˆ·æ–°å®Œæ¯•ï¼Œæ­¤æ—¶æ‰‹æ¾å¼€äº†')
      setTimeout(() => {
        this.refreshing = false
      }, 1000)
    },

    openComment(index) {
      // uni.setStorageSync('videoID', this.dataList[index]._id)
      this.$refs.pinglun.open('bottom')
    },
    clickShare() {
      uni.showToast({
        title: 'åˆ†äº«',
        icon: 'none'
      })
    },

    clickLike(like) {
      this.dataList[this.currentPlayer].isLike =
        !this.dataList[this.currentPlayer].isLike
      const video = this.dataList[this.currentPlayer]
      like ? (video.like ? video.like-- : video.like == 0) : video.like++
    },

    clickAvatar(i) {},

    closeCommentHandle() {},
    closeComment() {
      // ç‚¹å‡»è¯„è®ºé‡Œé¢çš„å‰å‰ï¼Œå°±ä¼šå…³é—­è¯„è®º
      this.$refs.pinglun.close()
    },

    // è§†é¢‘æ’­æ”¾çš„ä¸€ä¸ªå›è°ƒé€šçŸ¥ï¼Œ
    videoPlay(index) {
      setTimeout(() => {
        this.dataList[index].playIng = true
      }, 200)
    },

    clickCover() {
      uni.showToast({
        title: 'å¤„ç†å£°éŸ³',
        icon: 'none'
      })
    }
  }
}
</script>
<style scoped>
.container {
  background-color: #000000;
}
.videoHover {
  position: absolute;
  top: 0;
  left: 0;
  flex: 1;
  background-color: rgba(0, 0, 0, 0.1);
  justify-content: center;
  align-items: center;
}
.playState {
  width: 160rpx;
  height: 160rpx;
  opacity: 0.2;
}
.userInfo {
  position: absolute;
  bottom: 80px;
  right: 10px;
  flex-direction: column;
}
</style>
